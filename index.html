<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Visualisasi Lapisan Bumi - WebGL</title>

        <style>
        body { 
            margin: 0; 
            overflow: hidden;
            background-color: #272727;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
            background-size: 55px 55px;
            background-position: center center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        canvas { display: block; }

        /* === JUDUL === */
        #main-title {
            position: absolute;
            top: 20px; left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 20px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(4px);
            pointer-events: none; 
            z-index: 100;
        }
        
        /* === UI ATAS (CONTROL & ZOOM) === */
        #top-ui {
            position: absolute; 
            top: 20px; left: 20px;
            display: flex; 
            flex-direction: column; 
            gap: 8px;
            z-index: 100;
            width: 180px;
        }

        .button-row {
            display: flex;
            gap: 5px;
        }

        button {
            padding: 10px 15px; 
            font-size: 13px;
            background: rgba(30, 30, 30, 0.7);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            color: #ddd; 
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: all 0.2s ease;
            flex: 1;
        }
        button:hover, button.active {
            background: rgba(255,255,255, 0.9); 
            color: #000;
            border-color: white;
            font-weight: bold;
        }

        /* Tombol Zoom lebih kecil di baris kedua */
        .zoom-btn {
            font-size: 18px;
            font-weight: bold;
            padding: 5px 0;
        }

        /* === MENU LAYER (KIRI TENGAH) === */
        #layer-menu {
            position: absolute;
            top: 160px; /* Jarak dari atas sesuai sketsa */
            left: 20px;
            width: 180px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }

        .layer-btn {
            text-align: left;
            border-left: 4px solid transparent;
        }
        
        /* Indikator warna untuk setiap tombol layer */
        #btn-all { border-left-color: white; }
        #btn-crust { border-left-color: #5c4033; } /* Coklat */
        #btn-mantle { border-left-color: #cc5500; } /* Merah Bata */
        #btn-outer { border-left-color: #ff9900; } /* Oranye */
        #btn-inner { border-left-color: #ffdd77; } /* Kuning */

        .layer-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid white;
            /* Border kiri tetap warna masing-masing */
        }
        #btn-crust.active { border-left: 4px solid #5c4033; }
        #btn-mantle.active { border-left: 4px solid #cc5500; }
        #btn-outer.active { border-left: 4px solid #ff9900; }
        #btn-inner.active { border-left: 4px solid #ffdd77; }


        /* === DESKRIPSI & TOOLTIP === */
        #info-label {
            position: absolute; 
            display: none;
            background: rgba(0, 0, 0, 0.8);
            color: white; 
            padding: 5px 10px;
            border-radius: 4px;
            pointer-events: none; 
            font-size: 12px;
            z-index: 101;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        #description-box {
            position: absolute;
            right: 20px;
            top: 100px;
            width: 280px;
            padding: 20px;
            color: white;
            background: rgba(15, 15, 15, 0.85);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            display: none;
            z-index: 130;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #close-desc {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.7;
        }
        #close-desc:hover { opacity: 1; }
        
        h2 { margin-top: 0; font-size: 18px; color: #ffcc00; }
        p { font-size: 14px; line-height: 1.5; color: #ddd; }

        </style>
    </head>

    <body>

        <div id="main-title">Visualisasi Lapisan Bumi</div>

        <div id="top-ui">
            <button id="toggle-transparency">Buat Transparan</button>
            <button id="toggle-clipping">Toggle Irisan</button>
            
            <div class="button-row">
                <button id="zoom-in" class="zoom-btn" title="Zoom In">+</button>
                <button id="zoom-out" class="zoom-btn" title="Zoom Out">−</button>
            </div>
        </div>

        <div id="layer-menu">
            <button id="btn-all" class="layer-btn active" onclick="switchLayer('all')">Tampilkan Semua</button>
            <button id="btn-crust" class="layer-btn" onclick="switchLayer('Crust (Kerak Bumi)')">Kerak Bumi</button>
            <button id="btn-mantle" class="layer-btn" onclick="switchLayer('Mantle (Mantel)')">Mantel</button>
            <button id="btn-outer" class="layer-btn" onclick="switchLayer('Outer Core (Inti Luar)')">Inti Luar</button>
            <button id="btn-inner" class="layer-btn" onclick="switchLayer('Inner Core (Inti Dalam)')">Inti Dalam</button>
        </div>

        <div id="info-label"></div>

        <div id="description-box">
            <span id="close-desc">✖</span> 
            <h2 id="desc-title">Judul</h2>
            <p id="desc-text">Isi deskripsi...</p>
        </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";

    // === Variabel Global ===
    let isTransparent = false;
    let isClipped = false;
    let isHoveringUI = false;
    let currentActiveLayer = 'all'; // Melacak layer mana yang sedang dilihat

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const mousePos = { x: 0, y: 0 };
    const label = document.getElementById("info-label");
    const descriptionBox = document.getElementById("description-box");

    // Deskripsi Data
    const layerDescriptions = {
        "Crust (Kerak Bumi)": 
            "Kerak adalah lapisan terluar Bumi, tempat kita tinggal. Terdiri dari batuan padat dan mineral. Ketebalannya bervariasi: 5-10 km di bawah samudra dan 30-70 km di bawah benua.",
        "Mantle (Mantel)": 
            "Mantel adalah lapisan tertebal (sekitar 2.900 km). Terdiri dari batuan silikat semi-padat yang sangat panas. Arus konveksi di sini menggerakkan lempeng tektonik di atasnya.",
        "Outer Core (Inti Luar)": 
            "Inti Luar adalah lapisan logam cair (terutama besi dan nikel) setebal 2.400 km. Gerakan fluida di sini menciptakan efek dinamo yang menghasilkan medan magnet Bumi.",
        "Inner Core (Inti Dalam)": 
            "Inti Dalam adalah bola besi-nikel padat dengan radius 1.220 km. Meskipun suhunya sepanas permukaan Matahari (5.400°C), tekanan ekstrem membuatnya tetap padat."
    };

    // === Scene Setup ===
    const scene = new THREE.Scene();
    const capsGroup = new THREE.Group(); // Group penampung tutup irisan
    scene.add(capsGroup);
    capsGroup.visible = false; // Default mati

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 12;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setClearColor(0x000000, 0); 
    renderer.localClippingEnabled = false;
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enablePan = false;
    controls.minDistance = 0.1; 
    controls.maxDistance = 40;

    // Cahaya
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
    sunLight.position.set(5, 3, 5);
    scene.add(sunLight);

    // Bidang Irisan (Clipping Planes)
    const clipPlanes = [
        new THREE.Plane(new THREE.Vector3(1, 0, 0), 0), // Potong sumbu X
        new THREE.Plane(new THREE.Vector3(0, -1, 0), 0) // Potong sumbu Y
    ];

    // === Texture Loading ===
    const texLoader = new THREE.TextureLoader();
    const tCrust = texLoader.load("peta_kerak.png"); 
    const tInner = texLoader.load("inti_dalam.jpg");
    const tOuter = texLoader.load("inti_luar.jpg");
    const tMantle = texLoader.load("mantel.jpg");

    // === Create Layer Function ===
    // Fungsi helper untuk membuat Mesh Layer sekaligus Tutupnya (Cap)
    // agar tersimpan rapi dalam satu objek.
    function createLayer(name, radius, texture, color, emissiveColor, isInnerMost = false) {
        
        // 1. Buat Bola Utama
        const geometry = new THREE.SphereGeometry(radius, 64, 64);
        const material = new THREE.MeshStandardMaterial({
            map: texture,
            color: color,
            emissive: emissiveColor,
            emissiveIntensity: 0.2,
            roughness: 0.5,
            metalness: 0.1,
            clippingPlanes: clipPlanes,
            side: THREE.DoubleSide,
            transparent: name === "Outer Core (Inti Luar)" ? true : false,
            opacity: name === "Outer Core (Inti Luar)" ? 0.85 : 1.0
        });
        
        const mesh = new THREE.Mesh(geometry, material);
        mesh.userData.name = name;
        
        // 2. Buat Tutup (Cap) untuk layer ini
        // Hitung radius dalam (untuk membuat cincin). Jika Inner Core, radius dalam = 0.
        let innerRadius = 0;
        if (!isInnerMost) {
             // Logika sederhana: radius dalam kira-kira radius layer di bawahnya
             // Kita set manual nanti saat inisialisasi agar presisi, tapi ini default
             innerRadius = radius * 0.7; 
        }
        
        return mesh;
    }

    // === Inisialisasi Layer ===
    
    // 1. Inner Core (r=1.3)
    const inner = createLayer("Inner Core (Inti Dalam)", 1.3, tInner, 0xffffff, 0xffdd77, true);
    inner.material.emissiveIntensity = 0.6;

    // 2. Outer Core (r=2.2)
    const outer = createLayer("Outer Core (Inti Luar)", 2.2, tOuter, 0xffb347, 0xff7f24);
    outer.material.emissiveIntensity = 0.3;

    // 3. Mantle (r=3.0)
    const mantle = createLayer("Mantle (Mantel)", 3.0, tMantle, 0xffa64d, 0xcc6600);
    
    // 4. Crust (r=3.3)
    const crust = createLayer("Crust (Kerak Bumi)", 3.3, tCrust, 0xffffff, 0x222222);
    crust.material.roughness = 0.8;

    scene.add(inner, outer, mantle, crust);
    const layers = [crust, mantle, outer, inner]; // Urutan untuk Raycaster (Luar ke Dalam)


    // === Inisialisasi Tutup (Caps) ===
    // Kita buat tutup secara manual agar pas, lalu kita 'tempel' ke objek layer
    // supaya bisa kita kontrol visibilitasnya bersamaan.

    function createAndAttachCap(layerObj, innerR, outerR, colorHex) {
        let geo;
        if (innerR === 0) geo = new THREE.CircleGeometry(outerR, 64);
        else geo = new THREE.RingGeometry(innerR, outerR, 64);

        // Material Cap Horizontal (dipotong bidang vertikal)
        const matH = new THREE.MeshBasicMaterial({ 
            color: colorHex, side: THREE.DoubleSide, clippingPlanes: [clipPlanes[0]] 
        });
        // Material Cap Vertikal (dipotong bidang horizontal)
        const matV = new THREE.MeshBasicMaterial({ 
            color: colorHex, side: THREE.DoubleSide, clippingPlanes: [clipPlanes[1]] 
        });

        const capY = new THREE.Mesh(geo, matH);
        capY.rotation.x = -Math.PI / 2;
        
        const capX = new THREE.Mesh(geo, matV);
        capX.rotation.y = -Math.PI / 2;

        const group = new THREE.Group();
        group.add(capY, capX);

        // SIMPAN REFERENSI CAP DI DALAM USERDATA LAYER
        layerObj.userData.capMesh = group; 
        
        capsGroup.add(group);
    }

    createAndAttachCap(inner, 0, 1.3, 0xffdd77);
    createAndAttachCap(outer, 1.3, 2.2, 0xff9900);
    createAndAttachCap(mantle, 2.2, 3.0, 0xcc5500);
    createAndAttachCap(crust, 3.0, 3.3, 0x331100);


    // === LOGIKA GANTI LAYER (MENU) ===
    window.switchLayer = function(layerName) {
        currentActiveLayer = layerName;

        // Reset UI Buttons
        document.querySelectorAll('.layer-btn').forEach(btn => btn.classList.remove('active'));

        // 1. Jika "Tampilkan Semua"
        if (layerName === 'all') {
            document.getElementById('btn-all').classList.add('active');
            descriptionBox.style.display = 'none';

            // Nyalakan semua layer dan cap-nya
            layers.forEach(l => {
                l.visible = true;
                if(l.userData.capMesh) l.userData.capMesh.visible = true;
            });
        } 
        // 2. Jika memilih salah satu layer
        else {
            // Highlight tombol yang benar
            if(layerName.includes("Crust")) document.getElementById('btn-crust').classList.add('active');
            if(layerName.includes("Mantle")) document.getElementById('btn-mantle').classList.add('active');
            if(layerName.includes("Outer")) document.getElementById('btn-outer').classList.add('active');
            if(layerName.includes("Inner")) document.getElementById('btn-inner').classList.add('active');

            // Loop semua layer: Matikan yang lain, Nyalakan yang dipilih
            layers.forEach(l => {
                if (l.userData.name === layerName) {
                    l.visible = true;
                    if(l.userData.capMesh) l.userData.capMesh.visible = true;
                    
                    // Munculkan deskripsi otomatis
                    descriptionBox.style.display = "block";
                    document.getElementById("desc-title").textContent = l.userData.name;
                    document.getElementById("desc-text").textContent = layerDescriptions[l.userData.name];
                } else {
                    l.visible = false;
                    // Sembunyikan juga cap layer yang tidak aktif
                    if(l.userData.capMesh) l.userData.capMesh.visible = false;
                }
            });
        }
    };


    // === UI Logic: Tombol Standard ===
    document.getElementById("close-desc").onclick = () => {
        descriptionBox.style.display = "none";
        // Opsional: Kembali ke view 'all' jika ditutup? 
        // switchLayer('all'); 
    };

    document.getElementById("toggle-transparency").onclick = () => {
        isTransparent = !isTransparent;
        mantle.opacity = isTransparent ? 0.5 : 1.0;
        mantle.transparent = isTransparent;
        crust.opacity = isTransparent ? 0.6 : 1.0;
        crust.transparent = isTransparent;
        document.getElementById("toggle-transparency").textContent =
            isTransparent ? "Buat Solid" : "Buat Transparan";
    };

    document.getElementById("toggle-clipping").onclick = () => {
        isClipped = !isClipped;
        renderer.localClippingEnabled = isClipped;
        capsGroup.visible = isClipped; // Master switch untuk caps
        document.getElementById("toggle-clipping").textContent =
            isClipped ? "Tampilkan Penuh" : "Toggle Irisan";
    };

    // === UI Logic: Zoom ===
    const zoomStep = 1.5;
    function updateZoom(isZoomIn) {
        const currentDist = camera.position.distanceTo(controls.target);
        let newDist = isZoomIn ? 
            Math.max(currentDist - zoomStep, controls.minDistance) :
            Math.min(currentDist + zoomStep, controls.maxDistance);
        
        camera.position.setLength(newDist);
        controls.update(); 
    }
    document.getElementById("zoom-in").onclick = () => updateZoom(true);
    document.getElementById("zoom-out").onclick = () => updateZoom(false);

    // === Mouse Logic ===
    window.addEventListener("mousemove", (e)=>{
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        mousePos.x = e.clientX;
        mousePos.y = e.clientY;
        isHoveringUI = e.target.tagName !== 'CANVAS';
        if (isHoveringUI) label.style.display = 'none';
    });

    // Klik Objek (hanya aktif jika dalam mode All, kalau mode single layer sudah otomatis deskripsi)
    window.addEventListener("click", () => {
        if (isHoveringUI) return;
        if (currentActiveLayer !== 'all') return; // Jangan override jika sedang mode fokus layer

        raycaster.setFromCamera(mouse, camera);
        // Hanya raycast ke layer yang sedang visible
        const visibleLayers = layers.filter(l => l.visible);
        const intersects = raycaster.intersectObjects(visibleLayers);

        let foundObj = null;
        for (let i = 0; i < intersects.length; i++) {
            const hit = intersects[i];
            // Cek Clipping
            if (isClipped) {
                let isHidden = false;
                for (const plane of clipPlanes) {
                    if (plane.distanceToPoint(hit.point) < 0) { isHidden = true; break; }
                }
                if (isHidden) continue;
            }
            foundObj = hit.object;
            break; 
        }

        if (foundObj) {
             const title = foundObj.userData.name;
             descriptionBox.style.display = "block"; 
             document.getElementById("desc-title").textContent = title;
             document.getElementById("desc-text").textContent = layerDescriptions[title];
             
             // Highlight tombol menu yang sesuai secara visual saja
             document.querySelectorAll('.layer-btn').forEach(btn => btn.classList.remove('active'));
             if(title.includes("Crust")) document.getElementById('btn-crust').classList.add('active');
             else if(title.includes("Mantle")) document.getElementById('btn-mantle').classList.add('active');
             else if(title.includes("Outer")) document.getElementById('btn-outer').classList.add('active');
             else if(title.includes("Inner")) document.getElementById('btn-inner').classList.add('active');
        }
    });

    // Hover Tooltip
    function checkHover(){
        if (isHoveringUI) return;
        raycaster.setFromCamera(mouse, camera);
        const visibleLayers = layers.filter(l => l.visible);
        const intersects = raycaster.intersectObjects(visibleLayers);
        
        let foundObj = null;
        for (let i = 0; i < intersects.length; i++) {
            const hit = intersects[i];
            if (isClipped) {
                let isHidden = false;
                for (const plane of clipPlanes) {
                    if (plane.distanceToPoint(hit.point) < 0) { isHidden = true; break; }
                }
                if (isHidden) continue;
            }
            foundObj = hit.object;
            break; 
        }

        if (foundObj) {
            label.style.display = "block";
            label.textContent = foundObj.userData.name;
            label.style.left = mousePos.x + 15 + "px";
            label.style.top  = mousePos.y + 15 + "px";
            document.body.style.cursor = "pointer";
        } else {
            label.style.display = "none";
            document.body.style.cursor = "default";
        }
    }

    window.addEventListener("resize", ()=>{
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function animate(){
        requestAnimationFrame(animate);
        const speed = 0.0015; 
        
        // Putar semua layer
        layers.forEach(l => l.rotation.y += speed);

        controls.update();
        checkHover();
        renderer.render(scene, camera);
    }

    animate();
    </script>
    </body>
</html>