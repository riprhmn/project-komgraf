<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Visualisasi Lapisan Bumi - Space Edition</title>

        <style>
        body { 
            margin: 0; 
            overflow: hidden;
            background-color: #000000; 
            background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000000 70%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        canvas { display: block; }

        #main-title {
            position: absolute;
            top: 20px; left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 4px;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(0, 150, 255, 0.7);
            pointer-events: none; 
            z-index: 100;
        }
        
        #top-ui {
            position: absolute; 
            top: 20px; left: 20px;
            display: flex; 
            flex-direction: column; 
            gap: 8px;
            z-index: 100;
            width: 180px;
        }

        .button-row { display: flex; gap: 5px; }

        button {
            padding: 10px 15px; 
            font-size: 12px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 4px;
            color: #b0e0e6; 
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            flex: 1;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:hover, button.active {
            background: rgba(0, 255, 255, 0.2); 
            color: #fff;
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .zoom-btn { font-size: 16px; font-weight: bold; }

        #layer-menu {
            position: absolute;
            top: 200px; left: 20px;
            width: 180px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }

        .layer-btn { text-align: left; border-left: 3px solid transparent; }
        
        #btn-all { border-left-color: #fff; }
        #btn-crust { border-left-color: #8b5a2b; }
        #btn-mantle { border-left-color: #e65100; }
        #btn-outer { border-left-color: #ffab00; }
        #btn-inner { border-left-color: #ffff8d; }

        .layer-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-right: 1px solid rgba(255,255,255,0.5);
        }

        #info-label {
            position: absolute; 
            display: none;
            background: rgba(0, 10, 20, 0.9);
            color: #00ffff; 
            padding: 6px 12px;
            border: 1px solid #00ffff;
            border-radius: 0px;
            pointer-events: none; 
            font-size: 12px;
            z-index: 101;
            box-shadow: 0 0 10px rgba(0,255,255,0.3);
        }
        
        #description-box {
            position: absolute;
            right: 20px; top: 100px;
            width: 280px;
            padding: 25px;
            color: #e0e0e0;
            background: rgba(10, 10, 15, 0.9);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            display: none;
            z-index: 130;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        #close-desc {
            position: absolute; top: 10px; right: 15px;
            cursor: pointer; color: #ff4444;
        }
        
        h2 { margin-top: 0; font-size: 18px; color: #00ffff; border-bottom: 1px solid rgba(0,255,255,0.3); padding-bottom: 10px; }
        p { font-size: 14px; line-height: 1.6; }

        </style>
    </head>

    <body>

        <div id="main-title">Earth Layers: Space View</div>

        <div id="top-ui">
            <button id="toggle-audio">ðŸ”Š Voice Over: ON</button>
            <button id="toggle-transparency">X-Ray Mode</button>
            <button id="toggle-clipping">Toggle Slice</button>
            
            <div class="button-row">
                <button id="zoom-in" class="zoom-btn">+</button>
                <button id="zoom-out" class="zoom-btn">âˆ’</button>
            </div>
        </div>

        <div id="layer-menu">
            <button id="btn-all" class="layer-btn active" onclick="switchLayer('all')">FULL EARTH</button>
            <button id="btn-crust" class="layer-btn" onclick="switchLayer('Crust (Kerak Bumi)')">CRUST</button>
            <button id="btn-mantle" class="layer-btn" onclick="switchLayer('Mantle (Mantel)')">MANTLE</button>
            <button id="btn-outer" class="layer-btn" onclick="switchLayer('Outer Core (Inti Luar)')">OUTER CORE</button>
            <button id="btn-inner" class="layer-btn" onclick="switchLayer('Inner Core (Inti Dalam)')">INNER CORE</button>
        </div>

        <div id="info-label"></div>

        <div id="description-box">
            <span id="close-desc">âœ–</span> 
            <h2 id="desc-title">Judul</h2>
            <p id="desc-text">Isi deskripsi...</p>
        </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";

    let isTransparent = false;
    let isClipped = false;
    let isHoveringUI = false;
    let currentActiveLayer = 'all'; 
    let isMuted = false;
    let currentAudio = null; 

    const audioFiles = {
        "Crust (Kerak Bumi)": "audio_crust.mp3",
        "Mantle (Mantel)": "audio_mantle.mp3",
        "Outer Core (Inti Luar)": "audio_outer.mp3",
        "Inner Core (Inti Dalam)": "audio_inner.mp3"
    };

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const mousePos = { x: 0, y: 0 };
    const label = document.getElementById("info-label");
    const descriptionBox = document.getElementById("description-box");

    const layerDescriptions = {
        "Crust (Kerak Bumi)": "Lapisan terluar yang keras & dingin. Tempat kehidupan berlangsung.",
        "Mantle (Mantel)": "Lapisan batuan semi-cair yang sangat tebal & panas. Menggerakkan lempeng tektonik.",
        "Outer Core (Inti Luar)": "Lautan logam cair (besi & nikel) yang menciptakan medan magnet Bumi.",
        "Inner Core (Inti Dalam)": "Bola logam padat yang sangat panas karena tekanan ekstrem."
    };

    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.02); 

    const capsGroup = new THREE.Group();
    scene.add(capsGroup);
    capsGroup.visible = false;

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 12;
    camera.position.y = 3; 

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.localClippingEnabled = false;
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enablePan = false;
    controls.minDistance = 4; 
    controls.maxDistance = 30;

    scene.add(new THREE.AmbientLight(0x333333, 1.0)); 
    
    const sunLight = new THREE.DirectionalLight(0xffffff, 2.0);
    sunLight.position.set(10, 5, 10);
    scene.add(sunLight);

    const rimLight = new THREE.DirectionalLight(0x0044ff, 0.5);
    rimLight.position.set(-5, -5, -10);
    scene.add(rimLight);

    function createStars() {
        const starGeometry = new THREE.BufferGeometry();
        const starCount = 3000; 
        const posArray = new Float32Array(starCount * 3);

        for(let i = 0; i < starCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 100; 
        }

        starGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));

        const starMaterial = new THREE.PointsMaterial({
            size: 0.08,
            color: 0xffffff,
            transparent: true,
            opacity: 0.8,
        });

        const stars = new THREE.Points(starGeometry, starMaterial);
        scene.add(stars);
        return stars; 
    }

    const starField = createStars();

    const clipPlanes = [
        new THREE.Plane(new THREE.Vector3(1, 0, 0), 0),
        new THREE.Plane(new THREE.Vector3(0, -1, 0), 0) 
    ];

    const texLoader = new THREE.TextureLoader();
    const tCrust = texLoader.load("peta_kerak.png"); 
    const tInner = texLoader.load("inti_dalam.jpg");
    const tOuter = texLoader.load("inti_luar.jpg");
    const tMantle = texLoader.load("mantel.jpg");

    //Create Layer Function
    // === Create Layer Function (UPDATED: Double Shell) ===
    function createLayer(name, radius, texture, color, emissiveColor, solidColor, isInnerMost = false) {
        const group = new THREE.Group();
        group.userData.name = name; // Simpan nama di grup juga

        // 1. MESH LUAR (Tekstur + FrontSide)
        const geoOuter = new THREE.SphereGeometry(radius, 64, 64);
        const matOuter = new THREE.MeshStandardMaterial({
            map: texture,
            color: color,
            emissive: emissiveColor,
            emissiveIntensity: isInnerMost ? 0.8 : 0.1,
            roughness: 0.6,
            metalness: 0.2,
            clippingPlanes: clipPlanes,
            side: THREE.FrontSide, // Hanya gambar sisi luar
            transparent: name === "Outer Core (Inti Luar)" ? true : false,
            opacity: name === "Outer Core (Inti Luar)" ? 0.85 : 1.0
        });
        const meshOuter = new THREE.Mesh(geoOuter, matOuter);
        meshOuter.userData.name = name; // Penting untuk Raycaster
        
        // 2. MESH DALAM (Warna Solid + BackSide)
        const geoInner = new THREE.SphereGeometry(radius - 0.01, 64, 64); // Sedikit lebih kecil agar tidak flickering
        const matInner = new THREE.MeshStandardMaterial({
            color: solidColor, // Pakai warna solid dari caps
            roughness: 0.8,
            clippingPlanes: clipPlanes,
            side: THREE.BackSide, // Hanya gambar sisi dalam
            // Ikuti transparansi outer core agar konsisten
            transparent: name === "Outer Core (Inti Luar)" ? true : false,
            opacity: name === "Outer Core (Inti Luar)" ? 0.85 : 1.0
        });
        const meshInner = new THREE.Mesh(geoInner, matInner);
        meshInner.userData.name = name; // Penting untuk Raycaster

        // Gabungkan keduanya
        group.add(meshOuter);
        group.add(meshInner);
        
        return group;
    }

    const inner = createLayer("Inner Core (Inti Dalam)", 1.3, tInner, 0xffffff, 0xffdd77, 0xffdd77, true);
    inner.children[0].material.emissiveIntensity = 0.6;

    const outer = createLayer("Outer Core (Inti Luar)", 2.2, tOuter, 0xffb347, 0xff7f24, 0xff9900);
    outer.children[0].material.emissiveIntensity = 0.3;

    const mantle = createLayer("Mantle (Mantel)", 3.0, tMantle, 0xffa64d, 0xcc6600, 0xcc5500);

    const crust = createLayer("Crust (Kerak Bumi)", 3.3, tCrust, 0xffffff, 0x222222, 0x331100);
    crust.children[0].material.roughness = 0.8;

    scene.add(inner, outer, mantle, crust);
    const layers = [crust, mantle, outer, inner];

    function createAndAttachCap(layerObj, innerR, outerR, colorHex) {
        let geo = innerR === 0 ? new THREE.CircleGeometry(outerR, 64) : new THREE.RingGeometry(innerR, outerR, 64);
        const matH = new THREE.MeshBasicMaterial({ color: colorHex, side: THREE.DoubleSide, clippingPlanes: [clipPlanes[0]] });
        const matV = new THREE.MeshBasicMaterial({ color: colorHex, side: THREE.DoubleSide, clippingPlanes: [clipPlanes[1]] });
        
        const group = new THREE.Group();
        const capY = new THREE.Mesh(geo, matH); capY.rotation.x = -Math.PI / 2;
        const capX = new THREE.Mesh(geo, matV); capX.rotation.y = -Math.PI / 2;
        group.add(capY, capX);
        
        layerObj.userData.capMesh = group; 
        capsGroup.add(group);
    }

    createAndAttachCap(inner, 0, 1.3, 0xffdd77);
    createAndAttachCap(outer, 1.3, 2.2, 0xff8800);
    createAndAttachCap(mantle, 2.2, 3.0, 0xaa3300);
    createAndAttachCap(crust, 3.0, 3.3, 0x553322);

    function playVoiceOver(layerName) {
        if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }
        if (isMuted) return;
        if (audioFiles[layerName]) {
            currentAudio = new Audio(audioFiles[layerName]);
            currentAudio.play().catch(e => console.log("Audio missing"));
        }
    }
    function stopAudio() { if (currentAudio) currentAudio.pause(); }

    window.switchLayer = function(layerName) {
        currentActiveLayer = layerName;
        document.querySelectorAll('.layer-btn').forEach(btn => btn.classList.remove('active'));

        if (layerName === 'all') {
            document.getElementById('btn-all').classList.add('active');
            descriptionBox.style.display = 'none';
            stopAudio();
            layers.forEach(l => { l.visible = true; if(l.userData.capMesh) l.userData.capMesh.visible = true; });
        } else {
            playVoiceOver(layerName);
            if(layerName.includes("Crust")) document.getElementById('btn-crust').classList.add('active');
            if(layerName.includes("Mantle")) document.getElementById('btn-mantle').classList.add('active');
            if(layerName.includes("Outer")) document.getElementById('btn-outer').classList.add('active');
            if(layerName.includes("Inner")) document.getElementById('btn-inner').classList.add('active');

            layers.forEach(l => {
                const isMatch = l.userData.name === layerName;
                l.visible = isMatch;
                if(l.userData.capMesh) l.userData.capMesh.visible = isMatch;
                if(isMatch) {
                    descriptionBox.style.display = "block";
                    document.getElementById("desc-title").textContent = l.userData.name;
                    document.getElementById("desc-text").textContent = layerDescriptions[l.userData.name];
                }
            });
        }
    };

    document.getElementById("toggle-audio").onclick = function() {
        isMuted = !isMuted;
        stopAudio();
        this.textContent = isMuted ? "ðŸ”‡ OFF" : "ðŸ”Š ON";
        this.style.color = isMuted ? "#ff4444" : "#b0e0e6";
    };

    // === UI Logic: Tombol Transparansi (UPDATED) ===
    document.getElementById("toggle-transparency").onclick = () => {
        isTransparent = !isTransparent;

        const setOpacity = (layerGroup, opValOuter, opValInner) => {
            layerGroup.children.forEach(mesh => {
                mesh.material.transparent = isTransparent;

                mesh.material.opacity = (mesh.material.side === THREE.BackSide) ? opValInner : opValOuter;
                mesh.material.needsUpdate = true;
            });
        };

        setOpacity(mantle, 0.5, 0.5);
        setOpacity(crust, 0.6, 0.6);  
        document.getElementById("toggle-transparency").textContent =
            isTransparent ? "Buat Solid" : "Buat Transparan";
    };

    document.getElementById("toggle-clipping").onclick = function() {
        isClipped = !isClipped;
        renderer.localClippingEnabled = isClipped;
        capsGroup.visible = isClipped;
        this.textContent = isClipped ? "Full Earth" : "Slice Mode";
    };

    const zoomStep = 2;
    document.getElementById("zoom-in").onclick = () => { camera.position.setLength(Math.max(camera.position.length() - zoomStep, controls.minDistance)); };
    document.getElementById("zoom-out").onclick = () => { camera.position.setLength(Math.min(camera.position.length() + zoomStep, controls.maxDistance)); };

    window.addEventListener("mousemove", (e)=>{
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        mousePos.x = e.clientX; mousePos.y = e.clientY;
        isHoveringUI = e.target.tagName !== 'CANVAS';
        if (isHoveringUI) label.style.display = 'none';
    });

    window.addEventListener("click", () => {
        if (isHoveringUI || currentActiveLayer !== 'all') return;
        raycaster.setFromCamera(mouse, camera);
        const visibleLayers = layers.filter(l => l.visible);
        const intersects = raycaster.intersectObjects(visibleLayers);
        
        if (intersects.length > 0) {
             const title = intersects[0].object.userData.name;
             window.switchLayer(title);
        }
    });

    function checkHover(){
        if (isHoveringUI) return;
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(layers.filter(l => l.visible));
        if (intersects.length > 0) {
            label.style.display = "block";
            label.textContent = intersects[0].object.userData.name.split("(")[0].trim(); 
            label.style.left = (mousePos.x + 15) + "px";
            label.style.top  = (mousePos.y + 15) + "px";
            document.body.style.cursor = "pointer";
        } else {
            label.style.display = "none";
            document.body.style.cursor = "default";
        }
    }

    window.addEventListener("resize", ()=>{
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function animate(){
        requestAnimationFrame(animate);
        
        layers.forEach(l => l.rotation.y += 0.001);

        starField.rotation.y -= 0.0002;

        controls.update();
        checkHover();
        renderer.render(scene, camera);
    }

    animate();
    </script>
    </body>
</html>
